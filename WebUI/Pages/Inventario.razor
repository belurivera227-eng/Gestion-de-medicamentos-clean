@page "/inventario"
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Gesti√≥n de Inventario</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-primary">üì¶ Gesti√≥n de Inventario</h1>
        <div>
            <button class="btn btn-primary shadow-sm me-2" @onclick="() => AbrirModal()">
                <i class="oi oi-plus"></i> Nuevo Medicamento
            </button>
            <a href="/registrar-movimiento" class="btn btn-success shadow-sm">
                <i class="oi oi-transfer"></i> Movimiento
            </a>
        </div>
    </div>

    @* Buscador *@
    <div class="mb-3">
        <input type="text" class="form-control" placeholder="Buscar medicamento..." @bind="searchTerm" @bind:event="oninput" />
    </div>

    @if (medicamentos == null)
    {
        <div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>
    }
    else
    {
        <div class="card shadow-sm border-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Nombre</th>
                            <th class="text-center">Stock</th>
                            <th class="text-center">M√≠nimo</th>
                            <th class="text-center">Estado y Alertas</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var med in Filtrados)
                        {
                            <tr>
                                <td><strong>@med.NombreMedicamento</strong></td>
                                <td class="text-center">@med.StockActual</td>
                                <td class="text-center">@med.StockMinimo</td>
                                <td class="text-center">
                                    @* Alerta de Stock *@
                                    <span class="badge rounded-pill @(med.StockActual <= med.StockMinimo ? "bg-danger" : "bg-success")">
                                        @(med.StockActual <= med.StockMinimo ? "Reponer" : "OK")
                                    </span>

                                    @* Alerta de Vencimiento *@
                                    @if (med.FechaVencimientoProxima.HasValue)
                                    {
                                        var diasRestantes = (med.FechaVencimientoProxima.Value - DateTime.Now).Days;
                                        @if (diasRestantes <= 30)
                                        {
                                            <div class="mt-1">
                                                <span class="badge @(diasRestantes < 0 ? "bg-dark" : "bg-warning text-dark") shadow-sm" 
                                                      title="Vencimiento: @med.FechaVencimientoProxima.Value.ToShortDateString()">
                                                    <i class="oi @(diasRestantes < 0 ? "oi-circle-x" : "oi-warning")"></i> 
                                                    @(diasRestantes < 0 ? "VENCIDO" : $"Vence en {diasRestantes}d")
                                                </span>
                                            </div>
                                        }
                                    }
                                </td>
                                <td class="text-center">
                                    <a class="btn btn-outline-info btn-sm me-1" href="/nuevo-lote" title="Cargar Stock Inicial">
                                        <i class="oi oi-box"></i>
                                    </a>
                                    <button class="btn btn-outline-warning btn-sm me-1" @onclick="() => AbrirModal(med)" title="Editar Medicamento">
                                        <i class="oi oi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" @onclick="() => Eliminar(med.Id)" title="Eliminar del cat√°logo">
                                        <i class="oi oi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@* Formulario Modal (Se mantiene igual) *@
@if (mostrarModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">@(medicamentoEdit.Id == Guid.Empty ? "Nuevo Medicamento" : "Editar Medicamento")</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label font-weight-bold">Nombre del Medicamento</label>
                        <input type="text" class="form-control" @bind="medicamentoEdit.Nombre" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label font-weight-bold">Stock M√≠nimo para Alerta</label>
                        <input type="number" class="form-control" @bind="medicamentoEdit.StockMinimo" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                    <button class="btn btn-success" @onclick="Guardar">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<InventarioDTO>? medicamentos;
    private string searchTerm = "";
    private bool mostrarModal = false;
    private MedicamentoDTO medicamentoEdit = new();

    private IEnumerable<InventarioDTO> Filtrados =>
        medicamentos?.Where(m => m.NombreMedicamento.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ?? new List<InventarioDTO>();

    protected override async Task OnInitializedAsync() => await CargarDatos();

    private async Task CargarDatos() 
    {
        try {
            medicamentos = await Http.GetFromJsonAsync<List<InventarioDTO>>("api/Medicamento/inventario-completo");
        } catch (Exception ex) {
            Console.WriteLine("Error: " + ex.Message);
        }
    }

    private void AbrirModal(InventarioDTO? item = null)
    {
        if (item == null) {
            medicamentoEdit = new MedicamentoDTO { Id = Guid.Empty };
        } else {
            medicamentoEdit = new MedicamentoDTO { 
                Id = item.Id, 
                Nombre = item.NombreMedicamento, 
                StockMinimo = item.StockMinimo 
            };
        }
        mostrarModal = true;
    }

    private void CerrarModal() => mostrarModal = false;

    private async Task Guardar()
    {
        if (string.IsNullOrWhiteSpace(medicamentoEdit.Nombre)) return;

        if (medicamentoEdit.Id == Guid.Empty) {
            await Http.PostAsJsonAsync("api/Medicamento", medicamentoEdit);
        } else {
            await Http.PutAsJsonAsync($"api/Medicamento/{medicamentoEdit.Id}", medicamentoEdit);
        }
        mostrarModal = false;
        await CargarDatos();
    }

    private async Task Eliminar(Guid id)
    {
        bool confirmado = await JS.InvokeAsync<bool>("confirm", "¬øEliminar medicamento?");
        if (confirmado) {
            await Http.DeleteAsync($"api/Medicamento/{id}");
            await CargarDatos();
        }
    }

    // --- MODELOS LOCALES ACTUALIZADOS ---

    public class InventarioDTO {
        public Guid Id { get; set; }
        public string NombreMedicamento { get; set; } = "";
        public int StockMinimo { get; set; }
        public int StockActual { get; set; }
        // AGREGAMOS ESTA L√çNEA AQU√ç TAMBI√âN:
        public DateTime? FechaVencimientoProxima { get; set; }
    }

    public class MedicamentoDTO {
        public Guid Id { get; set; }
        public string Nombre { get; set; } = "";
        public int StockMinimo { get; set; }
    }
}