@page "/nuevo-lote"
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="container mt-4 mb-5">
    <div class="card shadow border-0">
        <div class="card-header bg-info text-white">
            <h3 class="mb-0"><i class="oi oi-box"></i> Cargar Stock Inicial (Nuevo Lote)</h3>
        </div>
        <div class="card-body p-4">
            
            <div class="mb-3">
                <label class="form-label font-weight-bold">1. Seleccione el Medicamento</label>
                <select class="form-select form-select-lg" 
                        value="@loteDto.MedicamentoId" 
                        @onchange="OnMedicamentoChanged">
                    <option value="@Guid.Empty">-- Seleccione el producto --</option>
                    @if (medicamentos != null)
                    {
                        @foreach (var med in medicamentos)
                        {
                            <option value="@med.Id">@med.NombreMedicamento</option>
                        }
                    }
                </select>
                @if(loteDto.MedicamentoId == Guid.Empty) 
                { 
                    <small class="text-danger">⚠️ Debe seleccionar un medicamento de la lista.</small> 
                }
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label font-weight-bold">2. Número de Lote</label>
                    <input type="text" class="form-control" @bind="loteDto.NumeroLote" placeholder="Ej: LOT-VIT-2026" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label font-weight-bold">3. Cantidad Inicial</label>
                    <input type="number" class="form-control" @bind="loteDto.Cantidad" min="1" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label font-weight-bold">4. Fecha de Vencimiento</label>
                    <input type="date" class="form-control" @bind-value="loteDto.FechaVencimiento" />
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label font-weight-bold">5. Proveedor de Origen</label>
                    <select class="form-select border-info" @bind="loteDto.ProveedorId">
                        <option value="@Guid.Empty">-- Seleccione el proveedor --</option>
                        @if (proveedores != null)
                        {
                            @foreach (var prov in proveedores)
                            {
                                <option value="@prov.Id">@prov.Nombre</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <a href="/inventario" class="btn btn-light me-2">Cancelar</a>
                <button class="btn btn-primary px-5 shadow" @onclick="GuardarLote">
                    <i class="oi oi-check"></i> Registrar Entrada
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private LoteDTO loteDto = new() { 
        FechaVencimiento = DateTime.Now.AddYears(1),
        Cantidad = 1,
        NumeroLote = ""
    };

    private List<MedSimpleDTO>? medicamentos;
    private List<ProveedorDTO>? proveedores;

    protected override async Task OnInitializedAsync()
    {
        try {
            medicamentos = await Http.GetFromJsonAsync<List<MedSimpleDTO>>("api/Medicamento/inventario-completo");
            proveedores = await Http.GetFromJsonAsync<List<ProveedorDTO>>("api/Proveedor");
        } catch (Exception ex) {
            Console.WriteLine("Error al inicializar: " + ex.Message);
        }
    }

    private void OnMedicamentoChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (Guid.TryParse(value, out var newGuid)) loteDto.MedicamentoId = newGuid;
        else loteDto.MedicamentoId = Guid.Empty;
    }

    private async Task GuardarLote()
    {
        if (loteDto.MedicamentoId == Guid.Empty || string.IsNullOrWhiteSpace(loteDto.NumeroLote))
        {
            await JS.InvokeVoidAsync("alert", "⚠️ Por favor, complete el medicamento y el número de lote.");
            return;
        }

        var response = await Http.PostAsJsonAsync("api/Medicamento/lote", loteDto);

        if (response.IsSuccessStatusCode)
        {
            await JS.InvokeVoidAsync("alert", "✅ ¡Stock cargado exitosamente!");
            Nav.NavigateTo("/inventario");
        }
        else
        {
            var errorBody = await response.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", "❌ Error: " + errorBody);
        }
    }

    public class LoteDTO {
        public Guid MedicamentoId { get; set; }
        public string NumeroLote { get; set; } = string.Empty;
        public int Cantidad { get; set; }
        public DateTime FechaVencimiento { get; set; }
        public Guid? ProveedorId { get; set; } // Campo clave
    }

    public class MedSimpleDTO {
        public Guid Id { get; set; } 
        public string NombreMedicamento { get; set; } = "";
    }

    public class ProveedorDTO {
        public Guid Id { get; set; }
        public string Nombre { get; set; } = "";
        public string Nit { get; set; } = "";
    }
}